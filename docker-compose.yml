# docker-compose.yml

services:

  # --- Servicio de Ollama (IA Embeddings) ---
  ollama:
    container_name: phoenix_ollama
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - fenix-net # <-- Usa fenix-net

  # --- Servicio del Backend (Go + Gin) ---
  backend:
    container_name: phoenix_backend
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    ports:
      - "8080:8080"
    volumes:
      - ./backend:/app
    environment:
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_SERVICE_KEY: ${SUPABASE_SERVICE_KEY}
      SUPABASE_JWT_SECRET: ${SUPABASE_JWT_SECRET}
      GIN_MODE: debug
      MEILI_HOST: http://meilisearch:7700
      MEILI_MASTER_KEY: unaclavesupersecreta123
      OLLAMA_URL: http://ollama:11434
    depends_on:
      - meilisearch
      - ollama # <-- AÑADIDO
    restart: unless-stopped
    networks:
      - fenix-net # <-- Usa fenix-net

  # --- Servicio del Frontend (SvelteKit) ---
  frontend:
    container_name: phoenix_frontend
    image: mcr.microsoft.com/playwright:focal
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - moda-organica_node_modules:/app/node_modules
    working_dir: /app
    environment:
      VITE_SUPABASE_URL: ${VITE_SUPABASE_URL}
      VITE_SUPABASE_ANON_KEY: ${VITE_SUPABASE_ANON_KEY}
      VITE_API_URL: http://backend:8080
    command: bash -c "pnpm install && pnpm playwright install && pnpm run dev --host"
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - fenix-net

  # --- Servicio de Búsqueda (MeiliSearch) ---
  meilisearch:
    container_name: phoenix_meilisearch
    image: getmeili/meilisearch:v1.3 # Considera usar una versión más reciente si hay
    ports:
      - "7700:7700"
    environment:
      - MEILI_MASTER_KEY=unaclavesupersecreta123
      - MEILI_ENV=development
    volumes:
      - meili_data:/meili_data
    restart: unless-stopped
    networks:
      - fenix-net # <-- Usa fenix-net

  # --- Servicio de Playwright para E2E Tests ---
  # Uso: docker-compose --profile test up -d playwright
  # Tests: docker-compose exec playwright pnpm test:e2e
  playwright:
    container_name: phoenix_playwright
    image: mcr.microsoft.com/playwright:v1.40.0-focal
    profiles:
      - test  # Solo se levanta con --profile test
    depends_on:
      frontend:
        condition: service_started
      backend:
        condition: service_started
    volumes:
      # Montar directorio frontend
      - ./frontend:/app
      # Volumen anónimo para node_modules (evita conflictos con host)
      - /app/node_modules
      # Volúmenes nombrados para reportes y resultados
      - playwright-report:/app/playwright-report
      - playwright-results:/app/test-results
    working_dir: /app
    environment:
      # URLs internas de Docker para acceder a los servicios
      BASE_URL: http://frontend:5173
      API_URL: http://backend:8080
      NODE_ENV: test
      # Variables para Playwright
      PLAYWRIGHT_HTML_REPORT: ./playwright-report
      PLAYWRIGHT_JSON_REPORT: ./test-results/results.json
    # Mantener el contenedor vivo para ejecutar tests manualmente
    # Los tests se ejecutan con: docker-compose exec playwright pnpm test:e2e
    command: sleep infinity
    networks:
      - fenix-net
    healthcheck:
      test: ["CMD", "node", "-v"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

# Definición de las redes personalizadas
networks:
  fenix-net: # <-- Usa fenix-net
    driver: bridge

# Definición de los volúmenes nombrados
volumes:
  moda-organica_node_modules:
  ollama_data:
  meili_data:
    driver: local
  # Volúmenes para reportes y resultados de Playwright
  playwright-report:
    driver: local
  playwright-results:
    driver: local